apiVersion: karectl.io/v1alpha1
kind: ResearchNetworkPolicy
metadata:
  name: {{ values.projectName | lower }}-network
  namespace: karectl-system
  labels:
    karectl.io/project: {{ values.projectName | lower }}
spec:
  project: {{ values.projectName | lower }}
  dataClassification: "{{ values.dataClassification }}"
  isolation: "{{ values.networkIsolation }}"
  
  ciliumPolicies:
    - name: {{ values.projectName | lower }}-egress
      spec:
        endpointSelector:
          matchLabels:
            karectl.io/project: {{ values.projectName | lower }}
        egress:
          # Allow internal cluster communication
          - toEntities:
            - cluster
          # Allow DNS
          - toEndpoints:
            - matchLabels:
                k8s:io.kubernetes.pod.namespace: kube-system
                k8s:app: kube-dns
            toPorts:
            - ports:
              - port: "53"
                protocol: UDP
          # Project-specific external sites
          {% if values.allowedExternalSites and values.allowedExternalSites | length > 0 %}{% for site in values.allowedExternalSites %}
          - toFQDNs:
            - matchName: "{{ site.domain }}"
            toPorts:
            {% for port in site.ports %}
            - ports:
              - port: "{{ port }}"
                protocol: TCP
            {% endfor %}
          {% endfor %}{% endif %}
